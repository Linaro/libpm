# Libpm

When the upstream support is brought for a specific Android device, the kernel customized interfaces are reworked to comply with the existing frameworks. The user space services which relied on those interfaces are no longer aligned with the kernel. The direct impact is a need to modify and sometimes to redesign these services leading to an extra amount of development time.

Another matter of fact is new devices are often forced to rewrite part of their power management services because the behavior of the new platforms is different.

Libpm is a set of utilities to provide the necessary components to handle the power management from the AOSP userspace. The main goal is to accelerate the upstream support of the new platforms by providing all the common parts which are usually repeated in the different device support. Additionnaly it provides libraries to provide unified interfaces to act on the different power management components like the power limits and consumption, the performance level, the thermal events, etc ...

Another benefit is this project can alleviate the burden of rewritting again and again the same code for the power and thermal HALs when it is possible to reuse generic parts provided by the libpm.

Lipm has three main parts. A set of libraries which do not relying on any AOSP components. That means they can be used on a GNU/Linux distro.

### The core libraries

#### The thermal library

This event based library can get thermal events like trip points crossed the way up and down, thermal zone enablement, trip point changed, etc ...

#### The performance library

The performance library finds out the existing performance knobs found here and there in sysfs and aggregate these information into a consistent interface making easier to deal with from an application.

#### The power library

The power library connects the Dynamic Thermal Power Management controller from the power capping framework. This framework is at its early stage but new features will be added in the kernel and taken into account by this library.

### The Hardware Abstraction Layers

The Thermal HAL and the power HAL are provided. They have no power management support yet but they provide enough material to speed up the power management enablement

### The thermal engine

Sometimes the services provided by the HALs are not enough and an additional component called the thermal engine has to be used to fulfill what could be missing. As the logic can be sensible, the thermal engine uses plugins which can be added separetely

## Getting started

1. Add the local manifest to the AOSP source directory

```
<manifest>
  <!-- Repositories -->
  <remote name="linaro" fetch="https://github.com:Linaro/libpm.git"/>
  <project path="external/libpm" name="libpm" revision="android" remote="linaro" groups="default"/>
</manifest>
```

For instance put the file in: <AOSP>/.repo/local_manifests/libpm.xml

2. Sync the code in AOSP

repo sync external/libpm

## Port your platforms

TODO

1. Thermal Engine

* configuration file

* plugins

2. Thermal HAL configuration file


## License

```
libpm (Default Apache v2)
├── hal
│   ├── power
│   └── thermal
├── lib (LGPL-v3)
│   ├── performance
│   ├── power
│   └── thermal
├── sepolicy
│   ├── power
│   └── thermal
└── thermal-engine
```

The entire project is Apache v2 except the core libraries which are LGPL-v3

## Roadmap

First step is Android mainline inclusion. Currently this project is not part of the AOSP which put on the table a chicken egg problem. We need an user to upstream but we need the code upstream to add a mainline user. That is particularly true for vendor partition which can not be generated by the AOSP sources directly.
